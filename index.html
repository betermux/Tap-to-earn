<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CS Bomb Simulator – fixed beeps</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{font-family:system-ui,sans-serif}
  body{margin:0;height:100vh;display:flex;flex-direction:column;
       justify-content:center;align-items:center;background:#111;color:#0f0}
  #display{font-size:3rem;margin:1rem 0;letter-spacing:2px}
  button{padding:1rem 2rem;margin:.5rem;font-size:1.1rem;border:none;
         border-radius:8px;cursor:pointer;transition:.2s}
  #plantButton{background:#c00;color:#fff}
  #defuseButton{background:#06c;color:#fff}
  button:disabled{opacity:.3;cursor:not-allowed}
</style>
</head>
<body>
  <h1>CS Bomb Simulator</h1>
  <div id="display">Hold to PLANT</div>
  <button id="plantButton">Hold to Plant (T)</button>
  <button id="defuseButton" disabled>Hold to Defuse (CT)</button>

<script>
/* ------------------------------------------------------------------ */
/* 1️⃣  Нэг л AudioContext үүсгээд бүхнийг түүнд найдна               */
/* ------------------------------------------------------------------ */
const ctx = new (window.AudioContext || window.webkitAudioContext)();

/* ----------------- SFX – урьдчилж татаж буулгаад RAM-д ------------ */
const SOUND_SRC = {
  planted:   'planted.mp3',
  defused:   'defused.mp3',
  ctWin:     'ct_win.mp3',
  explosion: 'explosion.mp3',
  tWin:      't_win.mp3'
};
const SFX = {};                        // {name: AudioBuffer}

async function loadAll() {
  await Promise.all(Object.entries(SOUND_SRC).map(async ([key,url])=>{
    const buf = await (await fetch(url)).arrayBuffer();
    SFX[key]  = await ctx.decodeAudioData(buf);
  }));
}

/* ----------------- тоглуулах туслах ------------------------------ */
function play(name, opts={}) {
  const buffer = SFX[name];
  if(!buffer) return;
  const src   = ctx.createBufferSource();
  const gain  = ctx.createGain();
  gain.gain.value = opts.volume ?? 1;
  src.buffer = buffer;
  src.connect(gain).connect(ctx.destination);
  src.start(ctx.currentTime + (opts.when ?? 0));
}

/* ----------------- beep (0.08 s) – context дахин үүсгэхгүй -------- */
function shortBeep(freq=1000, vol=0.12, dur=0.08){
  const osc  = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.frequency.value = freq;
  gain.gain.value     = vol;
  osc.connect(gain).connect(ctx.destination);
  osc.start();
  osc.stop(ctx.currentTime + dur);
}

/* ----------------- UI & state ------------------------------------ */
const plantBtn  = document.getElementById('plantButton');
const defuseBtn = document.getElementById('defuseButton');
const display   = document.getElementById('display');

let planted=false, secondsLeft=40, timerId=null, holdId=null;

/* бүрэн ачаалтал товчнуудыг disable байлгана */
plantBtn.disabled = defuseBtn.disabled = true;
loadAll().then(()=> plantBtn.disabled=false);

/* товчийг 5 сек дарах логик */
function addHold(btn, action){
  const start = e=>{
    e.preventDefault();
    if(holdId || (planted && btn===plantBtn)) return;
    holdId = setTimeout(()=>{action();holdId=null;},5000);
  };
  const cancel = ()=>{clearTimeout(holdId);holdId=null;};
  btn.addEventListener('mousedown',start);
  btn.addEventListener('touchstart',start,{passive:false});
  ['mouseup','mouseleave','touchend','touchcancel']
    .forEach(ev=>btn.addEventListener(ev,cancel));
}

/* ----------------- plant / defuse / explode ---------------------- */
function plantBomb(){
  planted=true;
  play('planted');
  plantBtn.disabled=true;
  defuseBtn.disabled=false;
  secondsLeft=40;
  display.textContent='40';
  timerId=setInterval(()=>{
    secondsLeft--;
    /* beep: <10 сек үед яаралтай higher pitch, <5 сек үед бүр өндөр */
    const f = secondsLeft<=5 ? 1800 : secondsLeft<=10 ? 1400 : 1000;
    shortBeep(f);
    display.textContent=secondsLeft.toString().padStart(2,'0');

    if(secondsLeft<=0) explode();
  },1000);
}

function defuseBomb(){
  if(!planted) return;
  clearInterval(timerId);
  planted=false;
  play('defused');
  play('ctWin',{when:1.4});
  resetAfter(3000);
}

function explode(){
  clearInterval(timerId);
  planted=false;
  play('explosion');       // шууд тоглоно
  play('tWin',{when:0.8});
  display.textContent='BOOM!';
  resetAfter(3500);
}

function resetAfter(ms){
  setTimeout(()=>{
    plantBtn.disabled=false;
    defuseBtn.disabled=true;
    display.textContent='Hold to PLANT';
  },ms);
}

/* ----------------- init ------------------------------------------ */
addHold(plantBtn, plantBomb);
addHold(defuseBtn, defuseBomb);
</script>
</body>
</html>