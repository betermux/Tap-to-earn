<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CS Bomb Simulator – 3D bomb + fixed hold</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{font-family:system-ui,sans-serif}
  body{margin:0;height:100vh;display:flex;flex-direction:column;
       justify-content:center;align-items:center;background:#111;color:#0f0}

  #display{font-size:3rem;margin:1rem 0;letter-spacing:2px}

  /* ─── IMAGE BUTTON ─── */
  .img-btn{position:relative;width:140px;height:140px;padding:0;border:none;
           background:none;cursor:pointer;transition:transform .15s ease}
  .img-btn:disabled{opacity:.35;cursor:not-allowed}
  .img-btn.pressed{transform:scale(.9)}          /* pop шахалт */

  .icon{width:100%;height:100%;object-fit:contain;pointer-events:none}

  /* ─── PROGRESS RING ─── */
  .progress-ring{position:absolute;top:-10px;left:-10px;width:160px;height:160px;
                 transform:rotate(-90deg);pointer-events:none}
  .progress-ring circle{stroke:#44ff44;stroke-width:8;fill:none;
                        stroke-dasharray:402.12;stroke-dashoffset:402.12}
  .loading .progress-ring circle{animation:progress 5s linear forwards}
  @keyframes progress{to{stroke-dashoffset:0}}
</style>
</head>
<body>
  <h1>CS Bomb Simulator</h1>
  <div id="display">Hold to PLANT</div>

  <!-- Plant (realistic bomb PNG) -->
  <button id="plantButton" class="img-btn" disabled>
    <img class="icon"
         src="https://cdn.pixabay.com/photo/2014/04/02/10/27/bomb-304849_1280.png"
         alt="Bomb">
    <svg class="progress-ring" viewBox="0 0 160 160">
      <circle cx="80" cy="80" r="64"></circle>
    </svg>
  </button>

  <!-- Defuse (wire-cutter 3-D-ish PNG) -->
  <button id="defuseButton" class="img-btn" disabled>
    <img class="icon"
         src="https://cdn.pixabay.com/photo/2013/07/12/16/31/wire-cutter-151060_1280.png"
         alt="Wire cutter">
    <svg class="progress-ring" viewBox="0 0 160 160">
      <circle cx="80" cy="80" r="64"></circle>
    </svg>
  </button>

<script>
/* ========= 1. AudioContext & preload ========= */
const ctx = new (window.AudioContext||window.webkitAudioContext)();
const SOUND = {planted:'planted.mp3',defused:'defused.mp3',
               ctWin:'ct_win.mp3',explosion:'explosion.mp3'};
const BUF = {};
async function loadAll(){
  await Promise.all(Object.entries(SOUND).map(async([k,u])=>{
    const b=await(await fetch(u)).arrayBuffer();
    BUF[k]=await ctx.decodeAudioData(b);
  }));
}

/* ========= 2. Helpers ========= */
function play(n,{vol=1,when=0}={}){
  const b=BUF[n]; if(!b) return;
  const s=ctx.createBufferSource(), g=ctx.createGain();
  g.gain.value=vol; s.buffer=b;
  s.connect(g).connect(ctx.destination);
  s.start(ctx.currentTime+when);
}
function beep(f=1000,v=0.12,d=0.08){
  const o=ctx.createOscillator(), g=ctx.createGain();
  o.frequency.value=f; g.gain.value=v;
  o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+d);
}

/* ========= 3. UI & state ========= */
const plantBtn=document.getElementById('plantButton');
const defuseBtn=document.getElementById('defuseButton');
const display=document.getElementById('display');
let planted=false, secs=40, tick=null, holdTimer=null;

/* Unified pointer-hold logic */
function addHold(btn, action){
  const start=e=>{
    if(btn.disabled) return;
    btn.classList.add('pressed','loading');
    holdTimer=setTimeout(()=>{action();stop();},5000);
  };
  const stop=()=>{
    clearTimeout(holdTimer); holdTimer=null;
    btn.classList.remove('pressed','loading');
    const c=btn.querySelector('circle');
    c.style.animation='none'; void c.offsetWidth; c.style.animation='';
  };
  btn.addEventListener('pointerdown',start);
  ['pointerup','pointercancel','pointerleave'].forEach(ev=>btn.addEventListener(ev,stop));
}

/* ========= 4. Actions ========= */
function plant(){
  planted=true; play('planted');
  plantBtn.disabled=true; defuseBtn.disabled=false;
  secs=40; display.textContent='40';
  tick=setInterval(()=>{
    secs--;
    beep(secs<=5?1800:secs<=10?1400:1000);
    display.textContent=secs.toString().padStart(2,'0');
    if(secs<=0) explode();
  },1000);
}
function defuse(){
  if(!planted) return;
  clearInterval(tick); planted=false;
  play('defused'); play('ctWin',{when:1.4});
  reset(3000);
}
function explode(){
  clearInterval(tick); planted=false;
  play('explosion');
  navigator.vibrate?.(1000);
  display.textContent='BOOM!';
  reset(1500);
}
function reset(ms){
  setTimeout(()=>{
    plantBtn.disabled=false; defuseBtn.disabled=true;
    display.textContent='Hold to PLANT';
  },ms);
}

/* ========= 5. Init ========= */
plantBtn.disabled=defuseBtn.disabled=true;
loadAll().then(()=>plantBtn.disabled=false);
addHold(plantBtn,plant);
addHold(defuseBtn,defuse);
</script>
</body>
</html>