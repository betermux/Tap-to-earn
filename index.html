<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CS Bomb Simulator – final merged</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{font-family:system-ui,sans-serif}
  body{margin:0;height:100vh;display:flex;flex-direction:column;
       justify-content:center;align-items:center;background:#111;color:#0f0}
  #display{font-size:3rem;margin:1rem 0;letter-spacing:2px}
  button{padding:1rem 2rem;margin:.5rem;font-size:1.1rem;border:none;
         border-radius:8px;cursor:pointer;transition:.2s}
  #plantButton{background:#c00;color:#fff}
  #defuseButton{background:#06c;color:#fff}
  button:disabled{opacity:.3;cursor:not-allowed}
</style>
</head>
<body>
  <h1>CS Bomb Simulator</h1>
  <div id="display">Hold to PLANT</div>
  <button id="plantButton">Hold to Plant (T)</button>
  <button id="defuseButton" disabled>Hold to Defuse (CT)</button>

<script>
/* ============= 1. Нэг AudioContext, дуугаа урьдчилж буулгах ============= */
const ctx = new (window.AudioContext || window.webkitAudioContext)();

const SOUND_SRC = {        // өөрийн MP3-ийн нэр эсвэл URL оруулна
  planted:   'planted.mp3',
  defused:   'defused.mp3',
  ctWin:     'ct_win.mp3',
  explosion: 'explosion.mp3'   // богино “boom”
};

const SFX = {};  // {key: AudioBuffer}

async function loadAll() {
  await Promise.all(Object.entries(SOUND_SRC).map(async ([k,u])=>{
    const ab = await (await fetch(u)).arrayBuffer();
    SFX[k]   = await ctx.decodeAudioData(ab);
  }));
}

/* ============= 2. Тоглуулах туслах ============= */
function play(name, {volume=1, when=0}={}) {
  const buf = SFX[name];
  if (!buf) return;
  const src  = ctx.createBufferSource();
  const gain = ctx.createGain();
  gain.gain.value = volume;
  src.buffer = buf;
  src.connect(gain).connect(ctx.destination);
  src.start(ctx.currentTime + when);
}

/* 0.08 s beep – context дахин үүсгэхгүй */
function shortBeep(freq=1000, vol=0.12, dur=0.08) {
  const osc  = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.frequency.value = freq;
  gain.gain.value     = vol;
  osc.connect(gain).connect(ctx.destination);
  osc.start();
  osc.stop(ctx.currentTime + dur);
}

/* ============= 3. UI, төлөв ============= */
const plantBtn  = document.getElementById('plantButton');
const defuseBtn = document.getElementById('defuseButton');
const display   = document.getElementById('display');

let planted=false, secondsLeft=40, timerId=null, holdId=null;

/* товч 5 сек дарах логик */
function addHold(btn, action){
  const start = e=>{
    e.preventDefault();
    if(holdId || (planted && btn===plantBtn)) return;
    holdId = setTimeout(()=>{action();holdId=null;},5000);
  };
  const cancel = ()=>{clearTimeout(holdId);holdId=null;};
  btn.addEventListener('mousedown',start);
  btn.addEventListener('touchstart',start,{passive:false});
  ['mouseup','mouseleave','touchend','touchcancel']
    .forEach(ev=>btn.addEventListener(ev,cancel));
}

/* ============= 4. Plant / Defuse / Explode ============= */
function plantBomb(){
  planted=true;
  play('planted');
  plantBtn.disabled=true;
  defuseBtn.disabled=false;
  secondsLeft=40;
  display.textContent='40';
  timerId=setInterval(()=>{
    secondsLeft--;
    /* pitch өндөрсөх логик */
    const f = secondsLeft<=5 ? 1800 : secondsLeft<=10 ? 1400 : 1000;
    shortBeep(f);
    display.textContent=secondsLeft.toString().padStart(2,'0');
    if(secondsLeft<=0) explode();
  },1000);
}

function defuseBomb(){
  if(!planted) return;
  clearInterval(timerId);
  planted=false;
  play('defused');
  play('ctWin',{when:1.4});
  resetAfter(3000);
}

function explode(){
  clearInterval(timerId);
  planted=false;
  play('explosion');          // зөвхөн “boom”
  if (navigator.vibrate) navigator.vibrate(1000); // 1 сек vibrate
  display.textContent='BOOM!';
  resetAfter(1500);
}

function resetAfter(ms){
  setTimeout(()=>{
    plantBtn.disabled=false;
    defuseBtn.disabled=true;
    display.textContent='Hold to PLANT';
  },ms);
}

/* ============= 5. Init ============= */
plantBtn.disabled = defuseBtn.disabled = true;
loadAll().then(()=> plantBtn.disabled=false);
addHold(plantBtn, plantBomb);
addHold(defuseBtn, defuseBomb);
</script>
</body>
</html>